<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.gstatic.com"> 
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/main.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://unpkg.com/vue@next"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<title>NSYSU Campus Bus</title>
</head>
<body>
    <div id="app">
        <app-title></app-title>
        <app-content></app-content>
        <app-navigator></app-navigator>
    </div>
    <script>
        const app = Vue.createApp({
            template: '<app-title :new-lang="newLang" />{{lang}}<app-content :page="current" @changeLang="changeLang" /><app-navigator :new-lang="newLang" @update="changePage" />',
            data(){
                return{
                    current: 0,
                    lang: "tw",
                    newLang: 0
                }
            },
            provide(){
                return{
                    current: this.current,
                    lang: Vue.computed(() => this.lang)
                }
            },
            methods:{
                changePage(val){
                    this.current = val;
                },
                changeLang(val){
                    this.lang = val;
                    this.newLang +=1;
                }
            }
        });
        var campusList, listLength=0;
        var stopNameList = {
            "Administration Square":{"tw":"行政大樓","cn":"行政大楼","en":"Administration Building","jp":"行政棟"},
            "Administration Building":{"tw":"行政大樓","cn":"行政大楼","en":"Administration Building","jp":"行政棟"},
            "Dorm H":{"tw":"H棟宿舍","cn":"H栋宿舍","en":"H Dormitory","jp":"H ドーミトリー"},
            "H Dormitory":{"tw":"H棟宿舍","cn":"H栋宿舍","en":"H Dormitory","jp":"H ドーミトリー"},
            "Activity Center":{"tw":"活動中心","cn":"活动中心","en":"Activity Center","jp":"アクティビティセンター"},
            "Wuling Road":{"tw":"武嶺路口","cn":"武岭路口","en":"Wuling Road","jp":"武嶺交差点"},
            "College of Liberal Arts":{"tw":"文學院","cn":"文学院","en":"College of Liberal Arts","jp":"文学院"},
            "MRT Sizihwan Station (LRT Hamasen Station)":{"tw":"捷運西子灣站 (輕軌哈瑪星站)","cn":"捷运西子湾站(轻轨哈玛星站)","en":"MRT Sihziwan Station (LRT Hamasen Station)","jp":"MRT西子湾駅(LRT哈瑪星駅)"},
            "未行駛":{"tw":"未行駛","cn":"未行驶","en":"Not in service","jp":"運休"},
        };

        function langFunc(langCode, langDict){
            var langNum;
            switch(langCode){
                case "tw" : langNum = 0; break;
                case "cn" : langNum = 1; break;
                case "en" : langNum = 2; break;
                case "jp" : langNum = 3; break;
                default : langNum = 0;
            }
            return langDict[langNum];
        }

        app.component('app-title',{
            template: '<div class="banner shadow"><div id="title">{{titleContent}}</div></div>',
            props: ['newLang'],
            inject: ['lang'],
            data(){
                return {
                    titleContent: ""
                }
            },
            methods: {
                getLang(){
                    var dict = {"tw":"校園公車資訊","cn":"校园公交信息","en":"Campus Bus Information","jp":"学内連絡バスインフォ"};
                    this.titleContent = dict[this.lang.value];
                }
            },
            beforeMount(){
                this.getLang();
            },
            beforeUpdate(){
                this.getLang();
            }
        });

        app.component('app-content',{
            template: '<div id="content_box"><div id="header"></div><div class="content"><campus-bus-list v-if="current===0" v-for="i in campusLen" :parent-i="i-1" :parent-list="campusList[i-1]" @refresh="refresh" /><city-bus-list v-if="current===1" v-for="i in busLen" :parent-i="i-1" :parent-list="busList[i-1]" @refresh="refresh" /><settings v-if="current===3" @changeLang="changeLang" /></div><div id="footer"></div></div>',
            data(){
                return {
                    current: 0,
                    campusLen: 0,
                    busLen: 0,
                    campusList: [],
                    busList: [],
                }
            },
            props: ['page'],
            inject: ['lang'],
            created(){
                this.fetchData();
                this.updateData();
            },
            beforeUpdate(){
                this.current = this.page;
            },
            methods:{
                fetchData: function(){
                    var _this = this;
                    if(_this.page==0){
                        $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=SC",function(data){
                            _this.campusList = data;
                            _this.campusLen = data.length;
                            console.log(data);
                        });
                    }else if(_this.page==1 && (_this.lang=="tw" || _this.lang=="cn")){
                        $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&T=CT",function(data){
                            _this.busList = data;
                            _this.busLen = data.length;
                            console.log(_this.list);
                        });
                    }else if(_this.page==1 && (_this.lang=="en" || _this.lang=="jp")){
                        $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=CT",function(data){
                            _this.busList = data;
                            _this.busLen = data.length;
                            console.log(_this.list);
                        });
                    }
                },
                updateData: function(){
                    var _this = this;
                    console.log(_this.lang);
                    console.log(_this.page);
                    setInterval(function(){
                        if(_this.page==0){
                            $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=SC",function(data){
                                _this.campusList = data;
                                _this.campusLen = data.length;
                                console.log(data);
                            });
                        }else if(_this.page==1 && (_this.lang=="tw" || _this.lang=="cn")){
                            $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&T=CT",function(data){
                                _this.busList = data;
                                _this.busLen = data.length;
                                console.log(_this.list);
                            });
                        }else if(_this.page==1 && (_this.lang=="en" || _this.lang=="jp")){
                            $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=CT",function(data){
                                _this.busList = data;
                                _this.busLen = data.length;
                                console.log(_this.list);
                            });
                        }
                    },10000);
                },
                refresh: function(){
                    this.campusList = [];
                    this.busList = [];
                    this.campusLen = 0;
                    this.busLen = 0;
                },
                changeLang: function(val){
                    this.$emit("changeLang",val);
                }
            },
            components:{
                'campus-bus-list': {
                    template:'<div class="campus_list shadow"><table style="width: 100%"><tr><td rowspan="2" style="width: 150px"><span class="campus_list_name">{{name}}</span></td><td><span class="campus_list_dept">{{dept}}</span><span class="campus_list_arrow"><span class="material-icons">arrow_forward</span></span><span class="campus_list_dest">{{dest}}</span><br v-if="isPhone && plate!=\'\'"><span class="campus_list_plate">{{plate}}</span></td></tr><tr><td><span class="campus_list_stop" :class="{reded:isRed}">{{stop}}</span></td></tr></table></div>',
                    props:["parentI","parentList"],
                    inject: ['lang','current'],
                    data(){
                        var lang = this.lang.value;
                        var current = this.current;
                        var dict_name = ["校","校","Campus","Campus"];
                        var dict_current = ["目前位置：","当前位置：","Current Stop: ","現在地："];
                        var listData = this.parentList;
                        return {
                            name : langFunc(lang,dict_name)+" "+listData.RouteID,
                            plate : listData.CarID==null ? "":"["+listData.CarID+"]",
                            dept : stopNameList[listData.DepartureEn][lang],
                            dest : stopNameList[listData.DestinationEn][lang],
                            stop : listData.StopName=="未行駛"? stopNameList[listData.StopName][lang] : langFunc(lang,dict_current)+stopNameList[listData.StopName][lang],
                            isRed : listData.StopName=="未行駛"?true:false,
                            isPhone : screen.width<700? true : false
                        }
                    },
                    beforeUnmount(){
                        this.$emit("refresh");
                    }
                },
                'city-bus-list':{
                    template:'<div class="campus_list shadow"><table style="width: 100%"><tr><td rowspan="2" style="width: 150px"><span class="campus_list_name">{{name}}</span></td><td><span class="campus_list_dept">{{dept}}</span><span class="campus_list_arrow"><span class="material-icons">arrow_forward</span></span><span class="campus_list_dest">{{dest}}</span></td></tr><tr><td><span class="campus_list_stop">{{stop}}</span></td></tr></table></div>',
                    props:["parentI","parentList"],
                    inject: ['lang','current'],
                    data(){
                        var lang = this.lang.value;
                        var current = this.current;
                        var dict_current = ["目前位置：","当前位置：","Current Stop: ","現在地："];
                        var listData = this.parentList;
                        return {
                            name : listData.RouteID,
                            plate : listData.CarID==null ? "":"["+listData.CarID+"]",
                            dept : lang=="tw" || lang=="cn"?listData.Departure:listData.DepartureEn,
                            dest : lang=="tw" || lang=="cn"?listData.Destination:listData.DestinationEn,
                            stop : listData.StopName,
                            isPhone : screen.width<700? true : false
                        }
                    },
                    beforeUnmount(){
                        this.$emit("refresh");
                    }
                },
                'settings': {
                    template :'<div class="settings_box shadow"><h3>語言 Language</h3><hr><select class="lang_select" v-model="language" @change="changeLang" ><option value="tw">繁體</option><option value="cn">简体</option><option value="en">English</option><option value="jp">日本語</option></select></div>',
                    data(){
                        return{
                            language: this.lang.value
                        }
                    },
                    inject: ['lang'],
                    methods:{
                        changeLang(){
                            this.$emit("changeLang",this.language);
                        }
                    }
                }
            }
        });

        app.component('app-navigator',{
            template: '<div class="navigator shadow"><navigator id="navigator" @update="changePage" /></div>',
            methods:{
                changePage(val){
                    this.$emit("update",val);
                }
            },
            updated(){
                this.newlangChild = this.newLang;
            },
            components:{
                'navigator': {
                    template: '<campus-button @changeToCampus="changePage" /><bus-button @changeToBus="changePage" /><timetable-button @changeToTimetable="changePage" /><config-button @changeToSettings="changePage" />',
                    methods:{
                        changePage(val){
                            this.$emit("update",val);
                        }
                    },
                    components: {
                        'campus-button':{
                            template: '<a href="" @click.stop.prevent="updatePage"><span class="material-icons">school</span><br>{{msg}}</a>',
                            inject: ['lang','current'],
                            data(){
                                var lang = this.lang.value;
                                var current = this.current;
                                var dict = ["校園公車","校园公交","Campus Bus","学内連絡バス"];
                                return{
                                    msg : langFunc(lang,dict)
                                }
                            },
                            methods:{
                                updatePage(){
                                    this.$emit("changeToCampus",0);
                                }
                            }
                        },
                        'bus-button':{
                            template: '<a href="" @click.stop.prevent="updatePage"><span class="material-icons">directions_bus</span><br>{{msg}}</a>',
                            inject: ['lang','current'],
                            data(){
                                var lang = this.lang.value;
                                var current = this.current;
                                var dict = ["市區公車","市区公交","City Bus","市内バス"];
                                return{
                                    msg : langFunc(lang,dict)
                                }
                            },
                            methods:{
                                updatePage(){
                                    this.$emit("changeToBus",1);
                                }
                            }
                        },
                        'timetable-button':{
                            template: '<a href="" @click.stop.prevent="updatePage"><span class="material-icons">departure_board</span><br>{{msg}}</a>',
                            inject: ['lang','current'],
                            data(){
                                var lang = this.lang.value;
                                var current = this.current;
                                var dict = ["時刻表","时刻表","Timetable","時刻表"];
                                return{
                                    msg : langFunc(lang,dict)
                                }
                            },
                            methods:{
                                updatePage(){
                                    this.$emit("changeToTimetable",2);
                                }
                            }
                        },
                        'config-button':{
                            template: '<a href="" @click.stop.prevent="updatePage"><span class="material-icons">settings</span><br>{{msg}}</a>',
                            inject: ['lang','current'],
                            data(){
                                var lang = this.lang.value;
                                var current = this.current;
                                var dict = ["設定","设置","Settings","設定"];
                                return{
                                    msg : langFunc(lang,dict)
                                }
                            },
                            methods:{
                                updatePage(){
                                    this.$emit("changeToSettings",3);
                                }
                            }
                        }
                    }
                }
            }
        });
        app.mount('#app');
        
        $("#header").height($(".banner").outerHeight());
        $("#footer").height($(".navigator").outerHeight());
    </script>
</body>
</html>
