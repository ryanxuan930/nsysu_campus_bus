<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.gstatic.com"> 
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/laoding.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://unpkg.com/vue@next"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<title>NSYSU Campus Bus</title>
</head>
<body>
    <div class="loading_background">
        <div class="loader">Loading...</div>
    </div>
    <div id="app"></div>
    <script>
    function startLaoding(){
        $(".loading_background").fadeIn(500);
    }
    function endLaoding(){
        $(".loading_background").fadeOut(1000);
    }
    const stopNameList = {
        "Administration Square":{"tw":"行政大樓","cn":"行政大楼","en":"Administration Building","jp":"行政棟"},
        "Administration Building":{"tw":"行政大樓","cn":"行政大楼","en":"Administration Building","jp":"行政棟"},
        "Dorm H":{"tw":"H棟宿舍","cn":"H栋宿舍","en":"H Dormitory","jp":"H ドーミトリー"},
        "H Dormitory":{"tw":"H棟宿舍","cn":"H栋宿舍","en":"H Dormitory","jp":"H ドーミトリー"},
        "Activity Center":{"tw":"活動中心","cn":"活动中心","en":"Activity Center","jp":"アクティビティセンター"},
        "Wuling Road":{"tw":"武嶺路口","cn":"武岭路口","en":"Wuling Road","jp":"武嶺交差点"},
        "College of Liberal Arts":{"tw":"文學院","cn":"文学院","en":"College of Liberal Arts","jp":"文学院"},
        "MRT Sizihwan Station (LRT Hamasen Station)":{"tw":"捷運西子灣站 (輕軌哈瑪星站)","cn":"捷运西子湾站(轻轨哈玛星站)","en":"MRT Sihziwan Station (LRT Hamasen Station)","jp":"MRT西子湾駅(LRT哈瑪星駅)"},
        "未行駛":{"tw":"未行駛","cn":"未行驶","en":"Not in service","jp":"運休"},
    };
        const app = Vue.createApp({
            template: '<app-title :title-lang="lang_code" /><app-content :app-lang="lang_code" :current-page="current_page" @changeLang="changeLang" @changePage="changePage" /><app-navigator :nav-lang="lang_code" @changePage="changePage" />',
            data(){
                return {
                    current_page: 0,
                    lang_code: "tw"
                }
            },
            methods:{
                changeLang(val){
                    this.lang_code=val;
                },
                changePage(val){
                    this.current_page=val;
                }
            },
            beforeCreate(){
                startLaoding();
            }
        });
        app.component('app-title',{
            template: '<div class="banner shadow"><div id="title">{{title}}</div></div>',
            data(){
                return {
                    title : ""
                }
            },
            props: ['titleLang'],
            methods:{
                getLang(){
                    var titleList = {"tw":"校園公車資訊","cn":"校园公交信息","en":"Campus Bus Information","jp":"学内連絡バスインフォ"};
                    this.title = titleList[this.titleLang];
                }
            },
            beforeMount(){
                this.getLang();
            },
            beforeUpdate(){
                this.getLang();
            }
        });
        app.component('app-content',{
            template: '<div id="content_box"><div id="header"></div><campus-bus-list v-if="current_page===0" v-for="i in campus_len"  :campus-data="campus_list[i-1]" /><city-bus-list v-if="current_page===1 && (app_lang==\'tw\' || app_lang==\'cn\')" v-for="i in city_len"  :city-data="city_list_ch[i-1]" @getCityRoute="fetchCityRoute" /><city-bus-list v-if="current_page===1 && (app_lang==\'en\' || app_lang==\'jp\')" v-for="i in city_len"  :city-data="city_list_en[i-1]" @getCityRoute="fetchCityRoute" /><timetable v-if="current_page===2 && (app_lang==\'tw\' || app_lang==\'cn\')" v-for="i in timetable_len"  :timetable-data="timetable_ch[i-1]" /><timetable v-if="current_page===2 && (app_lang==\'en\' || app_lang==\'jp\')" v-for="i in timetable_len"  :timetable-data="timetable_en[i-1]" /><settings v-if="current_page===3" :app-lang="app_lang" @changeLang="changeLang" /><route-content v-if="current_page===4" v-for="i in content_len" :content-data="content_list[i-1]" @changePage="changePage" /><div id="footer"></div></div>',
            data(){
                return {
                    current_page: 0,
                    page_temp: 0,
                    app_lang: this.appLang,
                    campus_len: 0,
                    campus_list: [],
                    city_list_ch: [],
                    city_len: 0,
                    city_list_en: [],
                    timetable_ch: [],
                    timetable_len: 0,
                    timetable_en: [],
                    timer: 0,
                    content_list:[],
                    content_len: 0,
                }
            },
            props: ["appLang","currentPage"],
            methods: {
                fetchStatus(){
                    this.current_page = this.currentPage;
                    this.app_lang = this.appLang;
                },
                fetchCampus(){
                    var _this = this, i;
                    $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=SC",function(data){
                        var nameList = {"tw": "校","cn": "校","en": "Campus","jp": "Campus"};
                        for(i=0; i<data.length; i++){
                            data[i].DepartureEn = stopNameList[data[i].DepartureEn][_this.appLang];
                            data[i].DestinationEn = stopNameList[data[i].DestinationEn][_this.appLang];
                            data[i].StopName = stopNameList[data[i].StopName][_this.appLang];
                            data[i].NameEn = nameList[_this.appLang]+" "+data[i].RouteID;
                        }
                        _this.campus_list = data;
                        _this.campus_len = data.length;
                    });
                },
                fetchCity(){
                    var _this = this, i;
                    $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&T=CT",function(data){
                        var newList={};
                        for(i=0; i<data.length; i++){
                            newList[i]={};
                            newList[i]["dept"] = data[i].Departure;
                            newList[i]["dest"] = data[i].Destination;
                            newList[i]["name"] = data[i].Name;
                            newList[i]["id"] = data[i].CarID.split(",",1)[0];
                            newList[i]["route"] = data[i].RouteID;
                        }
                        _this.city_list_ch = newList;
                        _this.city_len = data.length;
                        endLaoding();
                    });
                    $.getJSON("https://ibus.nsysu.edu.tw/API/RoutePath.aspx?"+Date.now()+"&C=en&T=CT",function(data){
                        var newList={};
                        for(i=0; i<data.length; i++){
                            newList[i]={};
                            newList[i]["dept"] = data[i].DepartureEn;
                            newList[i]["dest"] = data[i].DestinationEn;
                            newList[i]["name"] = data[i].NameEn;
                            newList[i]["id"] = data[i].CarID.split(",",1)[0];
                            newList[i]["route"] = data[i].RouteID;
                        }
                        _this.city_list_en = newList;
                    });
                },
                changeLang(val){
                    this.$emit("changeLang",val);
                },
                changePage(val){
                    this.$emit("changeLang",val);
                },
                fetchTimetable(){
                    var _this = this, i;
                    $.getJSON("https://ibus.nsysu.edu.tw/API/RouteTimeBoardName.aspx?1620312644823"+Date.now(),function(data){
                        var newList={};
                        for(i=0; i<data.Datas.length; i++){
                            newList[i]={};
                            newList[i]["id"] = data.Datas[i].TimeBoardID;
                            newList[i]["name"] = data.Datas[i].Name;
                        }
                        _this.timetable_ch = newList;
                        _this.timetable_len = data.Datas.length;
                    });
                    $.getJSON("https://ibus.nsysu.edu.tw/API/RouteTimeBoardName.aspx?C=en",function(data){
                        var newList={};
                        for(i=0; i<data.Datas.length; i++){
                            newList[i]={};
                            newList[i]["id"] = data.Datas[i].TimeBoardID;
                            newList[i]["name"] = data.Datas[i].NameEn;
                        }
                        _this.timetable_en = newList;
                    });
                },
                fetchCityRoute(val){
                    var _this = this, langCode;
                    startLaoding();
                    if(this.app_lang=="tw" || this.app_lang=="tw"){
                        langCode = "ch";
                    }else{
                        langCode = "en";
                    }
                    const aboutList = {"tw":"約", "cn": "约", "en":"About", "jp": "約"};
                    const timeList = {"tw":"分", "cn": "分", "en":"min", "jp": "分"};
                    const arrivingList = {"tw":"即將進站", "cn": "即将进站", "en":"Arriving", "jp": "到着"};
                    const approachingList = {"tw":"接近", "cn": "接近", "en":"Approaching", "jp": "接近"};
                    $.post("https://ibus.nsysu.edu.tw/API/RoutePathStop.aspx",{C: langCode, RID: val},function(data){
                        var list = JSON.parse(data);
                        var newList={}, temp;
                        for(i=0; i<list.length; i++){
                            newList[i]={};
                            newList[i]["id"] = list[i].StopID;
                            if(langCode=="en"){
                                newList[i]["name"] = list[i].NameEn;
                            }else{
                                newList[i]["name"] = list[i].Name;
                            }
                            newList[i]["no"] = list[i].SeqNo;
                            temp = list[i].ArrivedTime;
                            if(temp.indexOf(":") < 0){
                                switch(list[i].ArrivedTime){
                                    case "進站中":
                                        newList[i]["arrival"] = approachingList[_this.app_lang];
                                        break;
                                    case "將到站":
                                        newList[i]["arrival"] = arrivingList[_this.app_lang];
                                        break;
                                    default:
                                    newList[i]["arrival"] = aboutList[_this.app_lang] + " " + list[i].ArrivedTime + " " + timeList[_this.app_lang];
                                }
                            }else{
                                newList[i]["arrival"] = list[i].ArrivedTime;
                            }
                            newList[i]["time"] = list[i].RealArrivedTime;
                            if(list[i].isGoBack=="Y"){
                                newList[i]["direction"] = 1;
                            }else{
                                newList[i]["direction"] = 0;
                            }
                            endLaoding();
                        }
                        _this.content_list = newList;
                        _this.content_len = list.length;
                        console.log(_this.content_list);
                        _this.$emit("changePage",4);
                    });
                }
            },
            created(){
                this.fetchCampus();
                this.fetchCity();
                this.page_temp = this.current_page;
                this.timer = 0;
            },
            beforeUpdate(){
                this.fetchStatus();
            },
            updated(){
                if(this.current_page != this.page_temp){
                    if(this.current_page==0){
                        this.fetchCampus();
                    }else if(this.current_page==1){
                        this.fetchCity();
                    }else{
                        this.fetchTimetable();
                    }
                    this.page_temp = this.current_page;
                }
            },
            components: {
                'campus-bus-list': {
                    template:'<a class="a_tag" href=""><div class="campus_list shadow" @click.prevent="routeData(0)"><table style="width: 100%"><tr><td rowspan="2" style="width: 150px"><span class="campus_list_name"><div>{{campusData.NameEn}}</div><div class="campus_list_plate" v-if="campusData.CarID!=null">{{campusData.CarID}}</div></span></td><td><span class="campus_list_dept">{{campusData.DepartureEn}}</span><span class="campus_list_arrow"><span class="material-icons">arrow_forward</span></span><span class="campus_list_dest">{{campusData.DestinationEn}}</span></td></tr><tr><td><span class="campus_list_stop" :class="{reded: campusData.StopName==\'未行駛\' || campusData.StopName==\'未行驶\' || campusData.StopName==\'Not in service\' || campusData.StopName==\'運休\'?true:false}">{{campusData.StopName}}</span></td></tr></table></div></a>',
                    props:["campusData"],
                    methods: {
                        routeData(route){
                            alert("目前無資料");
                            //this.$emit("getCampusRoute",route);
                        }
                    }
                    
                },
                'city-bus-list': {
                    template:'<a class="a_tag" href="" @click.prevent="routeData(cityData.route)"><div class="campus_list shadow"><table style="width: 100%"><tr><td style="width: 150px"><span class="campus_list_name"><div>{{cityData.name}}</div><div class="campus_list_plate" v-if="cityData.id!=null">{{cityData.id}}</div></span></td><td><span class="campus_list_dept">{{cityData.dept}}</span><span class="campus_list_arrow"><span class="material-icons">arrow_forward</span></span><span class="campus_list_dest">{{cityData.dest}}</span></td></tr></table></div></a>',
                    props:["cityData"],
                    methods: {
                        routeData(route){
                            this.$emit("getCityRoute",route);
                        }
                    }
                },
                'timetable': {
                    template:'<a class="a_tag" href="" @click.prevent="openTimetable(timetableData.id)"><div class="campus_list shadow">{{timetableData.name}}</div></a>',
                    props:["timetableData"],
                    methods: {
                        openTimetable(id){
                            $.post("https://ibus.nsysu.edu.tw/API/RouteTimeBoardPath.aspx?" + Date.now(),{"TBID": id},function(data){
                                var imagePath = JSON.parse(data);
                                window.open(imagePath.TimeBoardImagePath);
                            });
                        }
                    }
                },
                'settings': {
                    template: '<div class="settings_box shadow"><h3>語言 Language</h3><hr><select v-model="language" @change="changeLang"><option value="tw">繁體</option><option value="cn">简体</option><option value="en">English</option><option value="jp">日本語</option></select></div>',
                    props:["appLang"],
                    data(){
                        return {
                            language: this.appLang
                        }
                    },
                    methods: {
                        changeLang(){
                            this.$emit("changeLang",this.language);
                        }
                    }
                },
                'route-content': {
                    template: '<div class="campus_list"><span class="campus_list_name"><div>{{contentData.arrival}}</div></span><span>{{contentData.name}}</span></div>',
                    props:["contentData"]
                }
            }
        });
        app.component('app-navigator',{
            template :'<div class="navigator shadow"><a href="" @click.stop.prevent="changePage(0)"><span class="material-icons">school</span><br>{{campus}}</a><a href="" @click.stop.prevent="changePage(1)"><span class="material-icons">directions_bus</span><br>{{city}}</a><a href="" @click.stop.prevent="changePage(2)"><span class="material-icons">departure_board</span><br>{{timetable}}</a><a href="" @click.stop.prevent="changePage(3)"><span class="material-icons">settings</span><br>{{settings}}</a></div>',
            data(){
                return {
                    campus: "",
                    city: "",
                    timetable: "",
                    settings: ""
                }
            },
            props: ['navLang'],
            methods: {
                getLang(){
                    const campusButton = {"tw": "校園公車","cn": "校园公交","en": "Campus Bus","jp": "学内連絡バス"};
                    const cityButton = {"tw": "市區公車","cn": "市区公交","en": "City Bus","jp": "市内バス"};
                    const timetableButton = {"tw": "時刻表","cn": "时刻表","en": "Timetable","jp": "時刻表"};
                    const settingsButton = {"tw": "設定","cn": "设置","en": "Settings","jp": "設定"};
                    this.campus = campusButton[this.navLang];
                    this.city = cityButton[this.navLang];
                    this.timetable = timetableButton[this.navLang];
                    this.settings = settingsButton[this.navLang];
                },
                changePage(page){
                    this.$emit("changePage",page);
                }
            },
            beforeMount(){
                this.getLang();
            },
            beforeUpdate(){
                this.getLang();
            }
        });
        app.mount('#app');
        $("#header").height($(".banner").outerHeight());
        $("#footer").height($(".navigator").outerHeight());
    </script>
</body>
</html>